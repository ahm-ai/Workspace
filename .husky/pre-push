#!/bin/bash
. "$(dirname -- "$0")/_/husky.sh"

# Find all .js files in the current directory
#!/bin/bash

# Find all modified .js files in the current directory
for file in $(git status -s | grep '^M' | grep -E '\.js$' | awk '{print $2}')
do
  # Check if a corresponding .spec.js file exists
  if [ -e "${file%.*}.spec.js" ]
  then
    # Run Jest with coverage and store the result
    coverage=$(npx jest --coverage "${file%.*}.spec.js" | grep "Statements" | awk '{print $4}' | tr -d '%')

    echo "Coverage for ${file%.*}.spec.js is ${coverage}%."

    # Check if coverage is less than 80%
    if [ $coverage -lt 80 ]
    then
      echo "Tests for ${file%.*}.spec.js must have at least 80% coverage." >&2
      exit 1
    fi
  else
    # No corresponding .spec.js file found
    echo "No tests found for ${file}."
    exit 1
  fi
done

npm test
